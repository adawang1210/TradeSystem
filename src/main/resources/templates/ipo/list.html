<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="_layout :: layout(~{::body})">
<body>
<div th:if="${flashMessage}" class="alert alert-success mb-3" th:text="${flashMessage}"></div>
<div th:if="${flashError}" class="alert alert-danger mb-3" th:text="${flashError}"></div>
<div th:if="${error}" class="alert alert-danger mb-3" th:text="${error}"></div>

<div class="card mb-4">
    <div class="card-body">
        <h3 class="card-title">My Wallet</h3>
        <p class="mb-2">
            <strong>User ID:</strong>
            <span th:text="${investor.investorId}"></span>
        </p>
        <div class="alert alert-info d-flex justify-content-between align-items-center">
            <div>
                <strong>Current Balance:</strong>
                <span th:text="${'$' + #numbers.formatDecimal(investor.balance, 1, 'COMMA', 2, 'POINT')}"></span>
            </div>
            <form class="d-flex gap-2" method="post" th:action="@{/investor/deposit}">
                <input type="number" class="form-control" name="amount" step="1" min="1" placeholder="Amount" required>
                <button class="btn btn-primary" type="submit">Top Up</button>
            </form>
        </div>
    </div>
</div>

<div class="card">
    <h2>Available IPOs</h2>
    <table>
        <thead>
        <tr>
            <th>Name</th>
            <th>Symbol</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Deadline</th>
            <th>Apply</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="ipo : ${ipos}">
            <td th:text="${ipo.stockName}"></td>
            <td th:text="${ipo.stockSymbol}"></td>
            <td th:text="${ipo.price}"></td>
            <td th:text="${ipo.totalQuantity}"></td>
            <td th:text="${#temporals.format(ipo.deadline, 'yyyy-MM-dd HH:mm')}"></td>
            <td>
                <button class="btn btn-dark btn-sm" th:if="${ipo.drawExecuted}" disabled>üèÅ FINISHED</button>
                <button class="btn btn-success btn-sm"
                        th:if="${!ipo.drawExecuted and #sets.contains(appliedStockIds, ipo.stockId)}"
                        disabled>Applied</button>
                <button class="btn btn-secondary btn-sm"
                        th:if="${!ipo.drawExecuted and !#sets.contains(appliedStockIds, ipo.stockId) and ipo.deadline.isBefore(T(java.time.LocalDateTime).now())}"
                        disabled>Ended</button>
                <form th:if="${!ipo.drawExecuted and !#sets.contains(appliedStockIds, ipo.stockId) and !ipo.deadline.isBefore(T(java.time.LocalDateTime).now())}"
                      method="post"
                      th:action="@{/ipo/apply}"
                      class="apply-form">
                    <input type="hidden" name="stockId" th:value="${ipo.stockId}"/>
                    <button type="submit" class="btn btn-primary btn-sm">Apply</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<div class="card mt-4">
    <div class="card-body">
        <h3 class="card-title mb-3">My Application History</h3>
        <p class="text-muted" th:if="${#lists.isEmpty(myRecords)}">No applications yet.</p>
        <div th:if="${!#lists.isEmpty(myRecords)}" class="table-responsive">
            <table class="table table-striped align-middle">
                <thead>
                <tr>
                    <th>Stock</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Status</th>
                    <th>Applied At</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="record : ${myRecords}">
                    <td th:text="${stockNames[record.stockId] != null ? stockNames[record.stockId] : record.stockId}"></td>
                    <td th:text="${'$' + #numbers.formatDecimal(record.pricePerLot, 1, 'COMMA', 2, 'POINT')}"></td>
                    <td th:text="${record.quantity}"></td>
                    <td>
                        <div th:switch="${record.status.name()}">
                            <span th:case="'PENDING'" class="badge bg-warning text-dark">PENDING</span>
                            <span th:case="'WON'" class="badge bg-success">WON</span>
                            <span th:case="'LOST'" class="badge bg-danger">LOST</span>
                            <span th:case="*" class="badge bg-secondary" th:text="${record.status}"></span>
                        </div>
                    </td>
                    <td th:text="${#temporals.format(record.applyTime, 'yyyy-MM-dd HH:mm')}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
</body>
</html>
