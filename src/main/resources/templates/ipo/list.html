<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="_layout :: layout(~{::body})">
<body>
<div class="card mb-4">
    <div class="card-body">
        <h3 class="card-title">My Wallet</h3>
        <p class="mb-2">
            <strong>User ID:</strong>
            <span th:text="${investor.investorId}"></span>
        </p>
        <div class="alert alert-info d-flex justify-content-between align-items-center">
            <div>
                <strong>Current Balance:</strong>
                <span th:text="${'$' + #numbers.formatDecimal(investor.balance, 1, 'COMMA', 2, 'POINT')}"></span>
            </div>
            <form class="d-flex gap-2" method="post" th:action="@{/investor/deposit}">
                <input type="number" class="form-control" name="amount" step="1000" min="1" placeholder="Amount" required>
                <button class="btn btn-primary" type="submit">Top Up</button>
            </form>
        </div>
    </div>
</div>

<div class="card">
    <h2>Available IPOs</h2>
    <table>
        <thead>
        <tr>
            <th>Name</th>
            <th>Symbol</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Deadline</th>
            <th>Apply</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="ipo : ${ipos}">
            <td th:text="${ipo.stockName}"></td>
            <td th:text="${ipo.stockSymbol}"></td>
            <td th:text="${ipo.price}"></td>
            <td th:text="${ipo.totalQuantity}"></td>
            <td th:text="${#temporals.format(ipo.deadline, 'yyyy-MM-dd HH:mm')}"></td>
            <td>
                <div th:if="${appliedStockIds.contains(ipo.stockId)}">
                    <span class="status-tag won">Applied</span>
                </div>
                <form th:if="${!appliedStockIds.contains(ipo.stockId)}" method="post" th:action="@{/ipo/apply}" class="apply-form">
                    <input type="hidden" name="stockId" th:value="${ipo.stockId}"/>
                    <span class="limit-label">Limit: 1 Share</span>
                    <button type="submit">Apply</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<div class="card mt-4">
    <div class="card-body">
        <h3 class="card-title mb-3">My Application History</h3>
        <p class="text-muted" th:if="${#lists.isEmpty(myRecords)}">No applications yet.</p>
        <div th:if="${!#lists.isEmpty(myRecords)}" class="table-responsive">
            <table class="table table-striped align-middle">
                <thead>
                <tr>
                    <th>Stock</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Status</th>
                    <th>Applied At</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="record : ${myRecords}">
                    <td th:text="${stockNames[record.stockId] != null ? stockNames[record.stockId] : record.stockId}"></td>
                    <td th:text="${'$' + #numbers.formatDecimal(record.pricePerLot, 1, 'COMMA', 2, 'POINT')}"></td>
                    <td th:text="${record.quantity}"></td>
                    <td>
                        <span class="badge"
                              th:classappend="${record.status.name() == 'PENDING'} ? ' bg-warning text-dark' :
                                               (record.status.name() == 'WON' ? ' bg-success' : ' bg-danger')"
                              th:text="${record.status}"></span>
                    </td>
                    <td th:text="${#temporals.format(record.applyTime, 'yyyy-MM-dd HH:mm')}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
</body>
</html>
